<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riverline Voice Agent Training</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid #222;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #fff;
            margin-bottom: 10px;
        }

        .header h1 span {
            color: #6366f1;
        }

        .header p {
            color: #888;
            font-size: 1.1rem;
        }

        /* Control Panel */
        .control-panel {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5558e3, #7c4fe8);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: #1a1a1a;
            color: #888;
            border: 1px solid #333;
        }

        .btn-secondary:hover {
            background: #222;
            color: #fff;
            border-color: #444;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-play {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-play:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-play.playing {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 1s infinite;
        }

        .btn-play.playing:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Transcript Button */
        .btn-transcript {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-transcript:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
        }

        .transcript-actions {
            margin: 20px 0;
            text-align: center;
        }

        .transcript-section {
            margin: 20px 0;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 10px;
            text-align: center;
        }

        /* Conversation Area */
        .conversation-area {
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            padding: 20px;
            min-height: 500px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .welcome-message {
            text-align: center;
            padding: 100px 20px;
            color: #666;
        }

        .welcome-message h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #888;
        }

        /* Status Banners */
        .status-banner {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-banner.starting {
            background: linear-gradient(135deg, #1e3a5f, #1e1e3f);
            border: 1px solid #3b82f6;
            color: #60a5fa;
        }

        /* Attempt Header */
        .attempt-header {
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #6366f1;
        }

        .attempt-header h3 {
            color: #a5b4fc;
            font-size: 1.2rem;
        }

        /* Messages */
        .message {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.collector {
            background: linear-gradient(135deg, #1a2744, #1a1a2e);
            border: 1px solid #2563eb;
            margin-right: 50px;
        }

        .message.defaulter {
            background: linear-gradient(135deg, #2d1f1f, #1a1a1a);
            border: 1px solid #dc2626;
            margin-left: 50px;
        }

        .message-header {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message.collector .message-header {
            color: #60a5fa;
        }

        .message.defaulter .message-header {
            color: #f87171;
        }

        .message-header .icon {
            font-size: 1.2rem;
        }

        .message-content {
            color: #d1d5db;
            line-height: 1.6;
        }

        /* Message highlight during audio playback */
        .message.playing {
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
            border-color: #10b981;
        }

        /* Judge Section */
        .judge-section {
            margin: 25px 0;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            text-align: center;
        }

        .judge-header {
            color: #fbbf24;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Verdict Card */
        .verdict-card {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .verdict-card.pass {
            background: linear-gradient(135deg, #064e3b, #0a2e1f);
            border: 1px solid #10b981;
        }

        .verdict-card.fail {
            background: linear-gradient(135deg, #4c1d1d, #2a1a1a);
            border: 1px solid #ef4444;
        }

        .verdict-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .verdict-card.pass .verdict-header {
            color: #34d399;
        }

        .verdict-card.fail .verdict-header {
            color: #f87171;
        }

        .verdict-feedback {
            color: #d1d5db;
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .verdict-hangup {
            color: #888;
            font-size: 0.9rem;
        }

        /* Optimizer Section */
        .optimizer-section {
            margin: 25px 0;
            padding: 15px;
            background: linear-gradient(135deg, #2d2a1a, #1a1a1a);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            text-align: center;
        }

        .optimizer-header {
            color: #fbbf24;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* New Prompt Card */
        .new-prompt-card {
            margin: 20px 0;
            padding: 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
        }

        .new-prompt-card h4 {
            color: #a5b4fc;
            margin-bottom: 15px;
        }

        .new-prompt-card pre {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.85rem;
            color: #9ca3af;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Success/Failure Banners */
        .success-banner {
            margin: 30px 0;
            padding: 30px;
            background: linear-gradient(135deg, #064e3b, #0a2e1f);
            border: 2px solid #10b981;
            border-radius: 12px;
            text-align: center;
        }

        .success-banner h2 {
            color: #34d399;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .success-banner p {
            color: #a7f3d0;
            font-size: 1.1rem;
        }

        .failure-banner {
            margin: 30px 0;
            padding: 30px;
            background: linear-gradient(135deg, #4c1d1d, #2a1a1a);
            border: 2px solid #ef4444;
            border-radius: 12px;
            text-align: center;
        }

        .failure-banner h2 {
            color: #f87171;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .failure-banner p {
            color: #fca5a5;
            font-size: 1.1rem;
        }

        /* Final Prompt */
        .final-prompt {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a2e1f, #0a1a0f);
            border: 1px solid #10b981;
            border-radius: 10px;
        }

        .final-prompt h4 {
            color: #34d399;
            margin-bottom: 15px;
        }

        .final-prompt pre {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.85rem;
            color: #9ca3af;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }

        /* TTS Status */
        .tts-status {
            margin: 15px 0;
        }

        .tts-generating {
            padding: 15px 20px;
            background: linear-gradient(135deg, #1a1a2e, #0a0a1a);
            border: 1px solid #6366f1;
            border-radius: 10px;
            color: #a5b4fc;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .tts-complete {
            padding: 15px 20px;
            background: linear-gradient(135deg, #1a2e1f, #0a1a0f);
            border: 1px solid #10b981;
            border-radius: 10px;
            color: #6ee7b7;
            font-size: 1rem;
            margin: 15px 0;
        }

        /* Successful Conversation Section */
        .successful-conversation {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #0f2a1f, #0a1a0f);
            border: 2px solid #10b981;
            border-radius: 12px;
        }

        .successful-conversation h4 {
            color: #34d399;
            margin-bottom: 20px;
            font-size: 1.2rem;
            padding-bottom: 10px;
            border-bottom: 1px solid #10b98140;
        }

        .successful-conversation .message {
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .successful-conversation .message.playing {
            border: 2px solid #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            transform: scale(1.02);
        }

        /* Audio Conversation Section */
        .audio-conversation {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e, #0a0a1a);
            border: 1px solid #6366f1;
            border-radius: 12px;
        }

        .audio-conversation h4 {
            color: #a5b4fc;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        /* Play Button */
        .play-btn {
            background: #10b981;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            transition: all 0.2s ease;
        }

        .play-btn:hover {
            background: #059669;
            transform: scale(1.1);
        }

        .play-btn.playing {
            background: #ef4444;
        }

        .play-btn.disabled {
            background: #374151;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .message.with-audio .message-header {
            display: flex;
            align-items: center;
        }

        .message.with-audio .message-header .icon {
            margin-right: 8px;
        }

        /* Divider */
        .divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #333, transparent);
            margin: 30px 0;
        }

        /* Loading indicator */
        .htmx-request .btn-primary {
            position: relative;
            color: transparent;
        }

        .htmx-request .btn-primary::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        .conversation-area::-webkit-scrollbar {
            width: 8px;
        }

        .conversation-area::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 4px;
        }

        .conversation-area::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .conversation-area::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        /* Info Cards */
        .info-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .info-card {
            background: #111;
            border: 1px solid #222;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .info-card .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .info-card h4 {
            color: #888;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .info-card p {
            color: #fff;
            font-size: 0.95rem;
        }

        /* Configuration Form */
        .config-section {
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .config-group {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #2a2a2a;
        }

        .config-group h4 {
            color: #a5b4fc;
            margin-bottom: 15px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #6366f1;
        }

        .form-group input::placeholder {
            color: #555;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Riverline <span>Voice Agent Training</span></h1>
            <p>Self-Improving Debt Collection Agent with AI-Powered Compliance</p>
        </div>

        <!-- Configuration Form -->
        <form id="config-form" class="config-section">
            <h3>‚öôÔ∏è Scenario Configuration</h3>
            <div class="config-grid">
                <!-- Debt Collector Settings -->
                <div class="config-group">
                    <h4>üè¶ Debt Collector</h4>
                    <div class="form-group">
                        <label for="collector_personality">Personality Style</label>
                        <select name="collector_personality" id="collector_personality">
                            <option value="aggressive and firm">Aggressive & Firm</option>
                            <option value="polite but persistent">Polite but Persistent</option>
                            <option value="empathetic and understanding">Empathetic & Understanding</option>
                            <option value="professional and neutral">Professional & Neutral</option>
                            <option value="friendly but assertive">Friendly but Assertive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="company_name">Company Name</label>
                        <input type="text" name="company_name" id="company_name" 
                               value="ABC Credit Card Company" placeholder="Enter company name">
                    </div>
                </div>

                <!-- Defaulter Settings -->
                <div class="config-group">
                    <h4>üë§ Defaulter (Customer)</h4>
                    <div class="form-group">
                        <label for="customer_name">Customer Name</label>
                        <input type="text" name="customer_name" id="customer_name" 
                               value="Alex" placeholder="Enter customer name">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="debt_amount">Debt Amount ($)</label>
                            <input type="number" name="debt_amount" id="debt_amount" 
                                   value="2500" min="100" step="100">
                        </div>
                        <div class="form-group">
                            <label for="months_overdue">Months Overdue</label>
                            <input type="number" name="months_overdue" id="months_overdue" 
                                   value="3" min="1" max="24">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="available_funds">Available Funds ($)</label>
                        <input type="number" name="available_funds" id="available_funds" 
                               value="400" min="0" step="50">
                    </div>
                </div>
            </div>
        </form>

        <div class="control-panel">
            <button class="btn btn-primary" 
                    hx-post="/start-training" 
                    hx-target="#conversation-area"
                    hx-swap="innerHTML"
                    hx-include="#config-form">
                üöÄ Start Training
            </button>
            <button id="playConversationBtn" class="btn btn-play" onclick="playFullConversation()" disabled>
                üîä Play Conversation
            </button>
            <button class="btn btn-secondary"
                    hx-post="/reset"
                    hx-target="#conversation-area"
                    hx-swap="innerHTML"
                    onclick="resetAudio()">
                üîÑ Reset
            </button>
        </div>

        <div id="conversation-area" class="conversation-area">
            <div class="welcome-message">
                <h3>üéØ Ready to Train</h3>
                <p>Configure your scenario above and click "Start Training" to begin.</p>
                <p style="margin-top: 15px; font-size: 0.9rem;">
                    The agent will attempt to pass compliance checks, learning from failures.
                </p>
            </div>
        </div>

        <div class="info-section">
            <div class="info-card">
                <div class="icon">üè¶</div>
                <h4>Debt Collector Agent</h4>
                <p>Llama 4 Scout</p>
            </div>
            <div class="info-card">
                <div class="icon">üë§</div>
                <h4>Defaulter</h4>
                <p>GPT-OSS-120B</p>
            </div>
            <div class="info-card">
                <div class="icon">‚öñÔ∏è</div>
                <h4>Judge</h4>
                <p>Gemini 2.0 Flash</p>
            </div>
            <div class="info-card">
                <div class="icon">üîä</div>
                <h4>Voice</h4>
                <p>ElevenLabs TTS</p>
            </div>
        </div>
    </div>

    <!-- Hidden audio player -->
    <audio id="audioPlayer" style="display: none;"></audio>

    <script>
        // Audio playback state
        let audioQueue = [];
        let currentIndex = 0;
        let isPlaying = false;
        let currentPlayingBtn = null;

        // Play individual audio message
        function playAudio(audioId, btn) {
            const player = document.getElementById('audioPlayer');
            
            // If this button is already playing, stop it
            if (currentPlayingBtn === btn && !player.paused) {
                player.pause();
                player.currentTime = 0;
                btn.innerHTML = '‚ñ∂Ô∏è';
                btn.classList.remove('playing');
                currentPlayingBtn = null;
                return;
            }
            
            // Stop any currently playing audio
            if (currentPlayingBtn) {
                currentPlayingBtn.innerHTML = '‚ñ∂Ô∏è';
                currentPlayingBtn.classList.remove('playing');
            }
            
            // Play the new audio
            player.src = `/audio/${audioId}`;
            player.play();
            
            btn.innerHTML = '‚èπÔ∏è';
            btn.classList.add('playing');
            currentPlayingBtn = btn;
            
            player.onended = function() {
                btn.innerHTML = '‚ñ∂Ô∏è';
                btn.classList.remove('playing');
                currentPlayingBtn = null;
            };
            
            player.onerror = function() {
                console.error('Error playing audio:', audioId);
                btn.innerHTML = '‚ùå';
                setTimeout(() => {
                    btn.innerHTML = '‚ñ∂Ô∏è';
                    btn.classList.remove('playing');
                }, 1000);
                currentPlayingBtn = null;
            };
        }

        // Play the full conversation
        async function playFullConversation() {
            const btn = document.getElementById('playConversationBtn');
            
            if (isPlaying) {
                // Stop playback
                stopPlayback();
                return;
            }
            
            // Fetch audio sequence from server
            try {
                const response = await fetch('/audio-sequence');
                const data = await response.json();
                audioQueue = data.audio_ids;
                
                if (audioQueue.length === 0) {
                    alert('No audio available. Run a training session first.');
                    return;
                }
                
                isPlaying = true;
                currentIndex = 0;
                updatePlayButton();
                playNextAudio();
                
            } catch (error) {
                console.error('Error fetching audio sequence:', error);
                alert('Error loading audio. Please try again.');
            }
        }

        // Play next audio in queue
        function playNextAudio() {
            if (!isPlaying || currentIndex >= audioQueue.length) {
                stopPlayback();
                return;
            }
            
            const player = document.getElementById('audioPlayer');
            const audioId = audioQueue[currentIndex];
            
            // Highlight current message
            highlightMessageByAudioId(audioId);
            
            player.src = `/audio/${audioId}`;
            player.play();
            
            player.onended = function() {
                currentIndex++;
                // Small delay between messages
                setTimeout(playNextAudio, 500);
            };
            
            player.onerror = function() {
                console.error('Error playing audio:', audioId);
                currentIndex++;
                setTimeout(playNextAudio, 100);
            };
        }

        // Play entire conversation sequence (auto-play after TTS generation)
        function playConversationSequence(audioIds) {
            if (!audioIds || audioIds.length === 0) return;
            
            audioQueue = audioIds;
            currentIndex = 0;
            isPlaying = true;
            
            console.log('üîä Auto-playing conversation with', audioIds.length, 'messages');
            playNextAudio();
        }

        // Highlight message by audio ID
        function highlightMessageByAudioId(audioId) {
            // Remove previous highlights
            document.querySelectorAll('.message.playing').forEach(msg => {
                msg.classList.remove('playing');
            });
            
            // Find and highlight the message with this audio ID
            const message = document.querySelector(`.message[data-audio-id="${audioId}"]`);
            if (message) {
                message.classList.add('playing');
                message.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Highlight the current message being played (by index - legacy)
        function highlightMessage(index) {
            // Remove previous highlights
            document.querySelectorAll('.message.playing').forEach(msg => {
                msg.classList.remove('playing');
            });
            
            // Get all messages in successful conversation and highlight the current one
            const messages = document.querySelectorAll('.successful-conversation .message');
            if (messages[index]) {
                messages[index].classList.add('playing');
                messages[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Stop playback
        function stopPlayback() {
            const player = document.getElementById('audioPlayer');
            player.pause();
            player.currentTime = 0;
            
            isPlaying = false;
            currentIndex = 0;
            
            // Remove all highlights
            document.querySelectorAll('.message.playing').forEach(msg => {
                msg.classList.remove('playing');
            });
            
            updatePlayButton();
        }

        // Update play button state
        function updatePlayButton() {
            const btn = document.getElementById('playConversationBtn');
            if (isPlaying) {
                btn.innerHTML = '‚èπÔ∏è Stop';
                btn.classList.add('playing');
            } else {
                btn.innerHTML = 'üîä Play Conversation';
                btn.classList.remove('playing');
            }
        }

        // Reset audio state
        function resetAudio() {
            stopPlayback();
            audioQueue = [];
            const btn = document.getElementById('playConversationBtn');
            btn.disabled = true;
        }

        // Check for audio trigger and auto-play
        function checkAndPlayAudio() {
            const trigger = document.getElementById('audio-trigger');
            if (trigger) {
                const audioIdsStr = trigger.getAttribute('data-audio-ids');
                console.log('üéØ Found audio-trigger with IDs:', audioIdsStr);
                if (audioIdsStr) {
                    try {
                        // Parse the audio IDs (they're comma-separated quoted strings)
                        const audioIds = audioIdsStr.split(',').map(id => id.replace(/"/g, '').trim()).filter(id => id);
                        if (audioIds.length > 0) {
                            console.log('üîä Auto-playing conversation with', audioIds.length, 'messages');
                            // Small delay to ensure UI is ready
                            setTimeout(() => {
                                playConversationSequence(audioIds);
                            }, 1000);
                        }
                    } catch (e) {
                        console.error('Error parsing audio IDs:', e);
                    }
                }
                // Remove trigger to prevent re-playing
                setTimeout(() => {
                    if (trigger && trigger.parentNode) {
                        trigger.remove();
                    }
                }, 2000);
            }
        }

        // Also use MutationObserver to catch dynamically added elements
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) {
                        // Check for audio trigger
                        if (node.id === 'audio-trigger') {
                            console.log('‚úÖ Detected audio-trigger element');
                            checkAndPlayAudio();
                        } else if (node.querySelector && node.querySelector('#audio-trigger')) {
                            console.log('‚úÖ Detected audio-trigger inside element');
                            checkAndPlayAudio();
                        }
                    }
                });
            });
        });

        // Start observing immediately
        observer.observe(document.body, { childList: true, subtree: true });

        // Also listen for HTMX events
        document.body.addEventListener('htmx:afterSwap', function(event) {
            console.log('üì° HTMX afterSwap event fired');
            // Check if audio-trigger was just added
            setTimeout(checkAndPlayAudio, 100);
        });

        // Check on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM Content Loaded');
            checkAndPlayAudio();
        });
    </script>
</body>
</html>
